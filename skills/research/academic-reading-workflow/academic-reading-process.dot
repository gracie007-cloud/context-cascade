digraph AcademicReadingWorkflow {
    rankdir=TB;
    compound=true;
    node [shape=box, style=filled, fontname="Arial"];
    edge [fontname="Arial"];

    // Start and end
    start [shape=ellipse, label="Start:\nSource to Read", fillcolor=lightgreen];
    end [shape=ellipse, label="Complete:\nSearchable Annotations", fillcolor=green, fontcolor=white];

    // Decision: Multi-source project?
    multi_source [shape=diamond, label="Multi-Source\nProject?", fillcolor=yellow];

    // Step 0: Master Keyword List (Optional)
    subgraph cluster_step0 {
        label="Step 0: Master Keyword List (Multi-Source Only)";
        fillcolor=lightyellow;
        style=filled;

        define_keywords [label="Define Standard\nKeyword Vocabulary"];
        create_master [label="Create Master List\n(10-20 keywords)"];
        store_master [label="Store in\nMemory MCP"];
        gate0 [shape=octagon, label="GATE 0:\nKeywords Defined?", fillcolor=lightblue];

        define_keywords -> create_master;
        create_master -> store_master;
        store_master -> gate0;
    }

    // Step 1: Summary-First Reading
    subgraph cluster_step1 {
        label="Step 1: Summary-First Reading (15-30 min)";
        fillcolor=lightblue;
        style=filled;

        read_summaries [label="Read: Abstract, Intro,\nConclusion, ToC"];
        thesis_check [shape=diamond, label="Clear\nThesis?", fillcolor=yellow];
        identify_thesis [label="Identify Main\nArgument"];
        identify_questions [label="Identify Key\nQuestions Instead", fillcolor=lightyellow];
        categorize_sections [label="Categorize Sections:\nCritical/Supp/Skip"];
        unfamiliar_check [shape=diamond, label="Unfamiliar\nDomain?", fillcolor=yellow];
        add_glossary [label="Add 'Define Terms'\nSub-Step", fillcolor=lightyellow];
        create_roadmap [label="Create Reading Roadmap\n+ Focus Question"];
        gate1 [shape=octagon, label="GATE 1:\nClear Plan?", fillcolor=lightblue];

        read_summaries -> thesis_check;
        thesis_check -> identify_thesis [label="yes"];
        thesis_check -> identify_questions [label="no"];
        identify_thesis -> categorize_sections;
        identify_questions -> categorize_sections;
        categorize_sections -> unfamiliar_check;
        unfamiliar_check -> add_glossary [label="yes"];
        unfamiliar_check -> create_roadmap [label="no"];
        add_glossary -> create_roadmap;
        create_roadmap -> gate1;
    }

    // Step 2: Deep Reading + Annotation
    subgraph cluster_step2 {
        label="Step 2: Deep Reading + Active Annotation (1-4 hours)";
        fillcolor=lightgreen;
        style=filled;

        // Reading phase
        read_critical [label="Read Critical Sections\n(Follow Roadmap)"];
        pause_paragraphs [label="Pause After Each\nParagraph: 'What's the point?'"];

        // Annotation phase
        create_annotation [label="Create Annotation:\nYAML + Summary + Keywords", fillcolor=lightyellow];
        paraphrase_check [shape=diamond, label="Can\nParaphrase?", fillcolor=yellow];
        reread [label="Re-read Until\nUnderstandable", fillcolor=orange];
        force_paraphrase [label="Force Paraphrase\nin OWN Words"];
        add_keywords [label="Tag with ≥2 Keywords\n(Use Master List)"];
        add_page [label="Add Page Number"];

        // Special cases
        long_book_check [shape=diamond, label="100+ Pages\nBook?", fillcolor=yellow];
        summary_note [label="Create Summary Note\nEvery 50 Pages", fillcolor=lightyellow];

        store_annotation [label="Store in Memory MCP\n(WHO/WHEN/PROJECT/WHY)"];
        gate2 [shape=octagon, label="GATE 2:\n≥20 Annotations?\n≥5 Keywords?", fillcolor=lightblue];
        gate2_fail [shape=octagon, label="Continue\nAnnotating", fillcolor=orange];

        read_critical -> pause_paragraphs;
        pause_paragraphs -> create_annotation;
        create_annotation -> paraphrase_check;
        paraphrase_check -> reread [label="no", color=orange];
        reread -> paraphrase_check [style=dashed, label="retry"];
        paraphrase_check -> force_paraphrase [label="yes"];
        force_paraphrase -> add_keywords;
        add_keywords -> add_page;
        add_page -> long_book_check;
        long_book_check -> summary_note [label="yes"];
        long_book_check -> store_annotation [label="no"];
        summary_note -> store_annotation;
        store_annotation -> gate2;
        gate2 -> gate2_fail [label="no", color=orange];
        gate2_fail -> read_critical [style=dashed, label="more annotation"];
    }

    // Step 3: Quality Check
    subgraph cluster_step3 {
        label="Step 3: Annotation Quality Check (15-30 min)";
        fillcolor=lightcyan;
        style=filled;

        // Completeness check
        analyst_check [label="ANALYST:\nCheck Completeness", shape=box];
        verify_keywords [label="Verify ≥2 Keywords\nPer Annotation"];
        verify_pages [label="Verify Page Numbers\nPresent"];
        verify_paraphrase [label="Verify Genuine\nParaphrases"];

        // Keyword consistency
        extract_keywords [label="Extract All\nKeywords Used"];
        check_consistency [label="Check for\nDuplicates/Synonyms"];
        standardize [label="Standardize Terms\n(Use Master List)", fillcolor=lightyellow];
        create_index [label="Create Keyword Index"];

        // Paraphrase quality
        sample_annotations [label="Sample 5-10\nAnnotations"];
        quote_check [shape=diamond, label=">30%\nQuote-Paraphrases?", fillcolor=yellow];
        fail_paraphrase [shape=octagon, label="Return to Step 2:\nForce Genuine Paraphrasing", fillcolor=red, fontcolor=white];

        // Searchability test
        test_search [label="Test Searchability:\nCan Find Passages?"];
        gate3 [shape=octagon, label="GATE 3:\n≥20 Notes, ≥5 Keywords,\n<30% Quotes, Searchable?", fillcolor=lightblue];
        gate3_fail [shape=octagon, label="Return to\nStep 2", fillcolor=orange];

        analyst_check -> verify_keywords;
        verify_keywords -> verify_pages;
        verify_pages -> verify_paraphrase;
        verify_paraphrase -> extract_keywords;
        extract_keywords -> check_consistency;
        check_consistency -> standardize;
        standardize -> create_index;
        create_index -> sample_annotations;
        sample_annotations -> quote_check;
        quote_check -> fail_paraphrase [label="yes", color=red];
        quote_check -> test_search [label="no"];
        test_search -> gate3;
        gate3 -> gate3_fail [label="no", color=orange];
        gate3_fail -> read_critical [ltail=cluster_step3, lhead=cluster_step2, style=dashed];
    }

    // External references
    memory_mcp [shape=cylinder, label="Memory MCP\n(Annotations + Keywords)", fillcolor=lightcoral];
    blue_principles [shape=folder, label="Blue's Principles:\nRoadmap First\nCommand-F in Real Life\nParaphrase > Highlighting", fillcolor=lightsalmon];
    writing_skill [shape=cylinder, label="evidence-based-writing\n(Separate Skill)", fillcolor=lightcoral];

    // Main flow
    start -> multi_source;
    multi_source -> define_keywords [lhead=cluster_step0, label="yes"];
    multi_source -> read_summaries [lhead=cluster_step1, label="no"];
    gate0 -> read_summaries [lhead=cluster_step1, label="pass", color=green];
    gate1 -> read_critical [lhead=cluster_step2, label="pass", color=green];
    gate2 -> analyst_check [lhead=cluster_step3, label="pass", color=green];
    gate3 -> end [label="pass", color=green];

    // External connections
    store_master -> memory_mcp [style=dashed, label="stores"];
    store_annotation -> memory_mcp [style=dashed, label="stores"];
    create_index -> memory_mcp [style=dashed, label="stores"];

    create_roadmap -> blue_principles [style=dashed, label="applies"];
    force_paraphrase -> blue_principles [style=dashed, label="applies"];
    add_keywords -> blue_principles [style=dashed, label="applies"];

    end -> writing_skill [style=dashed, label="feeds to\n(optional)", color=blue];

    labelloc="t";
    label="Academic Reading Workflow - Blue's 3-Phase Methodology\n3 Quality Gates | 2 Agents (researcher, analyst) | 2-6 hours";
    fontsize=16;
    fontname="Arial Bold";
}
