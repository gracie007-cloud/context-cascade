# Enforcement System Quick Reference

## What Does It Do?

Enforces the 5-phase workflow and Skill -> Task -> TodoWrite pattern through hooks.

## How Does It Work?

1. **Reminders**: Displays enforcement rules at critical points
2. **Tracking**: Logs all skill/task/todo invocations
3. **Detection**: Identifies violations after they occur
4. **Retention**: Ensures patterns survive context compaction
5. **Analysis**: Generates compliance reports

## Hook Flow

```
User Request
    -> UserPromptSubmit: Initialize state, display 5-phase
    -> Skill invoked
        -> PreToolUse: Log skill, display SOP reminder
        -> PostToolUse: Check compliance
    -> Task invoked
        -> PreToolUse: Display registry reminder
        -> PostToolUse: Log agent, remind TodoWrite
    -> TodoWrite invoked
        -> PostToolUse: Mark complete
    -> Context compacts
        -> PreCompact: Inject patterns
    -> Session ends
        -> Stop: Archive state
```

## State File

Location: `~/.claude/runtime/enforcement-state.json`

Contains:
- Session ID
- Workflow phase
- Skills invoked
- Agents spawned
- Violations detected
- TodoWrite status

## Common Commands

### Check Current State
```bash
bash .claude/hooks/enforcement/state-tracker.sh get_state
```

### Generate Report
```bash
bash .claude/hooks/enforcement/generate-report.sh
```

### Analyze Compliance
```bash
bash .claude/hooks/enforcement/analyze-compliance.sh
```

### Find Violations
```bash
bash .claude/hooks/enforcement/find-violations.sh
```

### Agent Usage
```bash
bash .claude/hooks/enforcement/agent-usage-report.sh
```

### Validate Transcript
```bash
bash .claude/hooks/enforcement/transcript-parser.sh
```

## Violation Types

| Type | Description |
|------|-------------|
| `generic_agent` | Non-registry agent type used |
| `missing_agents` | Skill invoked without Task() |
| `missing_todowrite` | Agents spawned without TodoWrite() |
| `skipped_phase` | Phase skipped in 5-phase workflow |

## What It CANNOT Do

- Prevent violations (only detect)
- Validate Task/Skill parameters (hook limitation)
- Force tool calls
- Auto-correct invalid actions
- Block selectively (can only block all or none)

## What It CAN Do

- Display strong reminders
- Detect all violations (after fact)
- Track complete history
- Generate compliance metrics
- Survive context compaction
- Feed into improvement system

## Installation

```bash
cd .claude/hooks/enforcement
bash INSTALL.sh
```

Then merge CONFIGURATION.json hooks into .claude/settings.json

## Testing

```bash
bash .claude/hooks/enforcement/test-hooks.sh
```

## Documentation

- `README.md` - Complete documentation
- `INTEGRATION-DIAGRAM.md` - System architecture
- `LIMITATIONS.md` - What cannot be enforced
- `CONFIGURATION.json` - Hook configuration
- `QUICK-REFERENCE.md` - This file

## Architecture Summary

```
Preventive Layer (Reminders)
    -> Detective Layer (Validation)
        -> Corrective Layer (Feedback)
            -> Retention Layer (Survival)
                -> Analysis Layer (Metrics)
```

## Key Files

| File | Purpose |
|------|---------|
| `state-tracker.sh` | Core state management |
| `user-prompt-submit.sh` | Initialize workflow |
| `pre-skill-invoke.sh` | Log skill, show reminder |
| `pre-task-spawn.sh` | Show registry reminder |
| `post-skill-compliance.sh` | Verify SOP compliance |
| `post-task-spawn.sh` | Log agent, remind TodoWrite |
| `post-todowrite.sh` | Mark pattern complete |
| `pattern-retention.sh` | Inject patterns (PreCompact) |
| `session-stop.sh` | Archive state |
| `transcript-parser.sh` | Async validation |

## Typical Workflow

1. User submits non-trivial request
2. UserPromptSubmit displays 5-phase reminder
3. Claude invokes Skill("intent-analyzer")
4. PreToolUse logs skill, displays SOP reminder
5. PostToolUse checks compliance
6. Claude invokes Task("coder", "...", "coder")
7. PreToolUse displays registry reminder
8. PostToolUse logs agent spawn
9. Claude invokes TodoWrite({todos: [...]})
10. PostToolUse marks pattern complete
11. check_compliance() runs -> PASS or FAIL

## Compliance Metrics

Generated by `analyze-compliance.sh`:
- Total sessions
- Total skills/agents/violations
- Registry compliance rate
- Violation rate
- Quality score (0-100)

## Integration

Feeds into recursive improvement:
```
Violations
    -> analyze-compliance.sh
        -> Compliance metrics
            -> audit-pipeline
                -> Skill improvements
                    -> Gated by eval harness
```

## Bottom Line

This is a **guardrail system**, not an **enforcement system**.

It GUIDES toward compliance but CANNOT force it.

Success depends on:
1. Strong reminders (preventive)
2. Violation detection (detective)
3. Actionable feedback (corrective)
4. Pattern retention (survival)
5. Claude's cooperation (critical!)
