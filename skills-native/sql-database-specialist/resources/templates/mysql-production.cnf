# MySQL Production Configuration Template
# Optimized for production workloads with 16GB RAM, 4 CPU cores
# Place in /etc/mysql/conf.d/production.cnf

[mysqld]

#------------------------------------------------------------------------------
# GENERAL
#------------------------------------------------------------------------------

user = mysql
pid-file = /var/run/mysqld/mysqld.pid
socket = /var/run/mysqld/mysqld.sock
port = 3306
basedir = /usr
datadir = /var/lib/mysql
tmpdir = /tmp

# Character set
character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci

# Time zone
default-time-zone = '+00:00'

#------------------------------------------------------------------------------
# CONNECTIONS
#------------------------------------------------------------------------------

max_connections = 200
max_connect_errors = 1000000
max_allowed_packet = 64M

# Connection timeout
wait_timeout = 600
interactive_timeout = 600

#------------------------------------------------------------------------------
# INNODB (Primary Storage Engine)
#------------------------------------------------------------------------------

# InnoDB buffer pool (50-70% of total RAM for dedicated DB server)
innodb_buffer_pool_size = 8G           # 50% of 16GB RAM
innodb_buffer_pool_instances = 8

# InnoDB log files (for write performance)
innodb_log_file_size = 1G              # Larger = better write performance
innodb_log_buffer_size = 16M
innodb_flush_log_at_trx_commit = 1     # 1 = ACID compliant, 2 = faster but less durable

# InnoDB I/O
innodb_io_capacity = 2000              # SSD (200 for HDD)
innodb_io_capacity_max = 4000          # SSD burst
innodb_flush_method = O_DIRECT         # Avoid double buffering
innodb_file_per_table = 1              # One file per table

# InnoDB concurrency
innodb_read_io_threads = 4
innodb_write_io_threads = 4
innodb_purge_threads = 4
innodb_page_cleaners = 4

# InnoDB monitoring
innodb_monitor_enable = all
innodb_print_all_deadlocks = 1

#------------------------------------------------------------------------------
# QUERY CACHE (Disabled in MySQL 8.0+)
#------------------------------------------------------------------------------

# MySQL 5.7 only (removed in 8.0)
# query_cache_type = 0
# query_cache_size = 0

#------------------------------------------------------------------------------
# TEMPORARY TABLES
#------------------------------------------------------------------------------

tmp_table_size = 64M
max_heap_table_size = 64M

#------------------------------------------------------------------------------
# SORT AND JOIN BUFFERS
#------------------------------------------------------------------------------

sort_buffer_size = 2M                  # Per connection
read_buffer_size = 2M                  # Sequential scan
read_rnd_buffer_size = 4M              # Order by
join_buffer_size = 2M                  # Join without index

#------------------------------------------------------------------------------
# TABLE CACHE
#------------------------------------------------------------------------------

table_open_cache = 4000
table_definition_cache = 2000
open_files_limit = 65535

#------------------------------------------------------------------------------
# BINARY LOGGING (for replication and point-in-time recovery)
#------------------------------------------------------------------------------

server-id = 1                          # Unique ID for replication
log_bin = /var/log/mysql/mysql-bin.log
binlog_format = ROW                    # ROW, STATEMENT, or MIXED
binlog_expire_logs_seconds = 604800    # 7 days
max_binlog_size = 100M
sync_binlog = 1                        # Safest (fsync after each commit)

# GTID for replication
gtid_mode = ON
enforce_gtid_consistency = ON

#------------------------------------------------------------------------------
# REPLICATION
#------------------------------------------------------------------------------

# Primary
binlog_do_db = production_db
binlog_ignore_db = mysql,information_schema,performance_schema

# Replica
relay_log = /var/log/mysql/mysql-relay-bin
relay_log_recovery = 1
read_only = 0                          # Set to 1 on replica

#------------------------------------------------------------------------------
# SLOW QUERY LOG
#------------------------------------------------------------------------------

slow_query_log = 1
slow_query_log_file = /var/log/mysql/slow-query.log
long_query_time = 0.5                  # Log queries > 500ms
log_queries_not_using_indexes = 1
min_examined_row_limit = 1000

#------------------------------------------------------------------------------
# GENERAL LOG (Disable in production for performance)
#------------------------------------------------------------------------------

general_log = 0
general_log_file = /var/log/mysql/general.log

#------------------------------------------------------------------------------
# ERROR LOG
#------------------------------------------------------------------------------

log_error = /var/log/mysql/error.log
log_error_verbosity = 2                # 1=errors, 2=+warnings, 3=+notes

#------------------------------------------------------------------------------
# PERFORMANCE SCHEMA
#------------------------------------------------------------------------------

performance_schema = ON
performance_schema_instrument = '%=ON'
performance_schema_consumer_events_statements_history_long = ON

#------------------------------------------------------------------------------
# SECURITY
#------------------------------------------------------------------------------

# SSL/TLS
require_secure_transport = ON
ssl-ca = /etc/mysql/ssl/ca.pem
ssl-cert = /etc/mysql/ssl/server-cert.pem
ssl-key = /etc/mysql/ssl/server-key.pem

# Disable LOCAL INFILE for security
local_infile = 0

# SQL mode (strict mode recommended)
sql_mode = STRICT_TRANS_TABLES,NO_ENGINE_SUBSTITUTION,NO_AUTO_CREATE_USER

#------------------------------------------------------------------------------
# OPTIMIZATION TIPS
#------------------------------------------------------------------------------

# 1. Monitor slow queries:
#    SELECT * FROM mysql.slow_log ORDER BY query_time DESC LIMIT 10;
#    Or use: mysqldumpslow /var/log/mysql/slow-query.log

# 2. Check InnoDB buffer pool hit ratio:
#    SELECT (1 - (Innodb_buffer_pool_reads / Innodb_buffer_pool_read_requests)) * 100
#    AS buffer_pool_hit_ratio FROM INFORMATION_SCHEMA.GLOBAL_STATUS;
#    Target: > 99%

# 3. Monitor replication lag:
#    SHOW SLAVE STATUS\G
#    Check: Seconds_Behind_Master

# 4. Check table statistics:
#    SELECT table_schema, table_name, table_rows, data_length, index_length
#    FROM information_schema.tables WHERE table_schema = 'your_db';

# 5. Analyze query execution:
#    EXPLAIN SELECT ... ;
#    Look for: type=ALL (bad), key=NULL (no index)

#------------------------------------------------------------------------------
# MYSQLDUMP OPTIMIZATION
#------------------------------------------------------------------------------

[mysqldump]
quick
quote-names
max_allowed_packet = 64M
single-transaction              # Consistent backup without locking

#------------------------------------------------------------------------------
# MYSQL CLIENT
#------------------------------------------------------------------------------

[mysql]
no-auto-rehash                  # Faster startup
