# Malware Sandbox Analysis Command

<!-- META-LOOP v2.1 INTEGRATION -->
## Phase 0: Expertise Loading
expertise_check:
  domain: security
  file: .claude/expertise/security.yaml
  fallback: discovery_mode

## Recursive Improvement Integration (v2.1)
benchmark: FILENAME-benchmark-v1
  tests:
    - audit_validation
    - quality_gate_pass
  success_threshold: 0.9
namespace: "commands/security/SUBDIR/FILENAME/{project}/{timestamp}"
uncertainty_threshold: 0.85
coordination:
  related_skills: [reverse-engineering-quick-triage]
  related_agents: [soc-compliance-auditor, penetration-testing-agent]

## COMMAND COMPLETION VERIFICATION
success_metrics:
  execution_success: ">95%"
<!-- END META-LOOP -->


**Category**: Reverse Engineering
**Phase**: 4 - Advanced Analysis
**Complexity**: High
**⚠️ SECURITY WARNING**: ONLY execute in isolated VM/Docker/E2B sandbox environments

## Purpose

Automated malware analysis in isolated sandbox environments with behavioral monitoring, network traffic capture, and threat intelligence correlation.

## Usage

```bash
/re:malware-sandbox [action] [options]

Actions:
  analyze             Full malware analysis
  static              Static analysis only
  dynamic             Dynamic execution analysis
  network             Network behavior capture
  report              Generate analysis report
  threat-intel        Correlate with threat databases

Options:
  --file <path>       Malware sample file
  --timeout <sec>     Analysis timeout (default: 300)
  --snapshot          Create VM snapshot before execution
  --network <mode>    Network mode (isolated|monitored|internet)
  --os <system>       Target OS (windows|linux|android)
  --headless          Run without GUI
  --extract-iocs      Extract Indicators of Compromise
```

## ⚠️ CRITICAL SECURITY WARNINGS

**MANDATORY REQUIREMENTS**:
1. ✅ **ALWAYS use isolated VM or Docker container**
2. ✅ **NEVER run on host system**
3. ✅ **Network isolation required** (no production network access)
4. ✅ **Snapshot/restore capability** (revert after each analysis)
5. ✅ **No sensitive data** in sandbox environment
6. ✅ **Malware samples encrypted** at rest (password-protected)

**Recommended Platforms**:
- **Cuckoo Sandbox** (automated malware analysis)
- **ANY.RUN** (interactive sandbox)
- **Joe Sandbox** (commercial solution)
- **Docker** (Linux malware analysis)
- **E2B Sandboxes** (cloud-based isolation)
- **VirtualBox** with snapshots
- **VMware** with isolated networks

## Examples

```bash
# Full automated analysis (recommended)
/re:malware-sandbox analyze --file suspicious.exe --os windows --network isolated --snapshot

# Static analysis only (safe, no execution)
/re:malware-sandbox static --file malware.dll --extract-iocs

# Dynamic analysis with network monitoring
/re:malware-sandbox dynamic --file trojan.exe --network monitored --timeout 600

# Network behavior analysis
/re:malware-sandbox network --file backdoor.exe --network internet --timeout 300

# Generate comprehensive report
/re:malware-sandbox report --file analyzed-sample.exe

# Threat intelligence correlation
/re:malware-sandbox threat-intel --file sample.exe --virustotal --hybridanalysis
```

## Sandbox Environment Setup

### 1. Cuckoo Sandbox (Recommended)

```bash
# Install Cuckoo
pip install cuckoo

# Setup virtual environment
cuckoo init

# Configure Cuckoo
cuckoo community

# Start Cuckoo
cuckoo -d

# Submit sample for analysis
cuckoo submit /path/to/malware.exe

# Get analysis report
cuckoo report <task_id>
```

### 2. Docker Sandbox (Linux Malware)

```yaml
# docker-compose.yml
version: '3.8'

services:
  malware-sandbox:
    build: .
    container_name: malware-analysis
    network_mode: none  # Isolated network
    volumes:
      - ./samples:/samples:ro
      - ./reports:/reports
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp
```

```dockerfile
# Dockerfile
FROM ubuntu:22.04

# Install analysis tools
RUN apt-get update && apt-get install -y \
    strace ltrace \
    tcpdump wireshark-common \
    file binutils \
    python3 python3-pip \
    volatility3 \
    && rm -rf /var/lib/apt/lists/*

# Install Python analysis tools
RUN pip3 install \
    pefile \
    yara-python \
    virustotal-api \
    capstone \
    unicorn

WORKDIR /analysis
```

### 3. E2B Sandbox Integration

```javascript
// Use E2B for cloud-based malware analysis
const { Sandbox } = require('e2b');

async function analyzeMalware(samplePath) {
  const sandbox = await Sandbox.create({
    template: 'base',
    networkPolicy: 'ISOLATED',  // No internet access
  });

  try {
    // Upload malware sample
    await sandbox.uploadFile(samplePath, '/tmp/sample');

    // Static analysis
    const staticAnalysis = await sandbox.exec('file /tmp/sample');
    const strings = await sandbox.exec('strings /tmp/sample | grep -i http');

    // Dynamic analysis (controlled execution)
    const strace = await sandbox.exec('strace -f -o /tmp/strace.log /tmp/sample', {
      timeout: 60000,
      onStdout: (output) => console.log('[STDOUT]', output),
      onStderr: (output) => console.log('[STDERR]', output),
    });

    // Network traffic capture
    const tcpdump = await sandbox.exec('tcpdump -i any -w /tmp/traffic.pcap &');

    // Download results
    const report = await sandbox.downloadFile('/tmp/strace.log');

    return {
      static: staticAnalysis,
      strings: strings,
      network: tcpdump,
      report: report,
    };
  } finally {
    await sandbox.close();
  }
}
```

## Analysis Workflow

### 1. Static Analysis (Safe - No Execution)

```bash
# File identification
file suspicious.exe
# Output: PE32 executable (GUI) Intel 80386, for MS Windows

# Calculate hashes
md5sum suspicious.exe
sha256sum suspicious.exe

# Extract strings
strings suspicious.exe | grep -E "http|ftp|\.exe|\.dll"

# PE file analysis
pefile suspicious.exe

# Check VirusTotal
curl -X POST https://www.virustotal.com/api/v3/files \
  -H "x-apikey: YOUR_API_KEY" \
  -F "file=@suspicious.exe"

# YARA rule matching
yara rules.yar suspicious.exe

# Disassemble entry point
objdump -D -M intel suspicious.exe | head -100
```

### 2. Dynamic Analysis (Requires Sandbox)

```bash
# System call tracing
strace -f -o strace.log ./suspicious.exe

# Library call tracing
ltrace -f -o ltrace.log ./suspicious.exe

# Network monitoring
tcpdump -i any -w network.pcap &
./suspicious.exe
killall tcpdump

# File system monitoring
inotifywait -m -r -e create,modify,delete /tmp &
./suspicious.exe

# Process monitoring
ps aux | grep suspicious
lsof -p <PID>
/proc/<PID>/maps
```

### 3. Network Behavior Analysis

```bash
# Capture DNS queries
tcpdump -i any port 53 -w dns.pcap

# Monitor HTTP/HTTPS traffic
mitmproxy --mode transparent --showhost

# Analyze network connections
netstat -antp | grep suspicious
ss -tuln

# Extract URLs from PCAP
tshark -r network.pcap -Y http.request -T fields -e http.host -e http.request.uri
```

## Behavioral Indicators

### File System Activity
```python
# Monitor file operations
import inotify.adapters

def monitor_filesystem():
    i = inotify.adapters.Inotify()
    i.add_watch('/tmp')
    i.add_watch('/etc')
    i.add_watch('/home')

    for event in i.event_gen(yield_nones=False):
        (_, type_names, path, filename) = event
        print(f"EVENT: {type_names} - {path}/{filename}")
```

### Registry Modifications (Windows)
```powershell
# Monitor registry changes
$before = Get-ChildItem -Path HKLM:\ -Recurse
./malware.exe
$after = Get-ChildItem -Path HKLM:\ -Recurse
Compare-Object $before $after
```

### Network Indicators
```yaml
network_iocs:
  - IP: 185.220.101.45
    Port: 8080
    Protocol: TCP
    Description: C2 server connection

  - Domain: malicious-domain.com
    Resolution: 192.0.2.123
    Description: Command and control

  - URL: http://evil.com/payload.exe
    Method: GET
    Description: Malware download
```

## Threat Intelligence Correlation

### VirusTotal Integration

```python
import virustotal_python

def check_virustotal(file_hash):
    vt = virustotal_python.Virustotal(API_KEY)
    response = vt.request(f"files/{file_hash}")

    return {
        'malicious': response['data']['attributes']['last_analysis_stats']['malicious'],
        'total_engines': response['data']['attributes']['last_analysis_stats']['total'],
        'tags': response['data']['attributes']['tags'],
        'names': response['data']['attributes']['names']
    }
```

### Hybrid Analysis

```bash
# Submit to Hybrid Analysis
curl -X POST "https://www.hybrid-analysis.com/api/v2/submit/file" \
  -H "api-key: YOUR_API_KEY" \
  -F "file=@suspicious.exe" \
  -F "environment_id=120"
```

## IOC Extraction

```python
import re
import pefile

def extract_iocs(file_path):
    with open(file_path, 'rb') as f:
        data = f.read()

    iocs = {
        'ips': re.findall(r'\b(?:[0-9]{1,3}\.){3}[0-9]{1,3}\b', data.decode('utf-8', errors='ignore')),
        'domains': re.findall(r'[a-zA-Z0-9-]+\.[a-zA-Z]{2,}', data.decode('utf-8', errors='ignore')),
        'urls': re.findall(r'https?://[^\s]+', data.decode('utf-8', errors='ignore')),
        'emails': re.findall(r'\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b', data.decode('utf-8', errors='ignore')),
    }

    # PE-specific IOCs
    try:
        pe = pefile.PE(file_path)
        iocs['imports'] = [entry.dll.decode() for entry in pe.DIRECTORY_ENTRY_IMPORT]
        iocs['exports'] = [exp.name.decode() for exp in pe.DIRECTORY_ENTRY_EXPORT.symbols if exp.name]
    except:
        pass

    return iocs
```

## Analysis Report Template

```json
{
  "analysis_id": "mal-20251101-abc123",
  "timestamp": "2025-11-01T12:00:00Z",
  "sample": {
    "filename": "suspicious.exe",
    "md5": "5d41402abc4b2a76b9719d911017c592",
    "sha256": "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",
    "filesize": 524288,
    "filetype": "PE32 executable"
  },
  "static_analysis": {
    "packer": "UPX",
    "compiler": "MSVC 14.0",
    "imports": ["kernel32.dll", "ws2_32.dll", "advapi32.dll"],
    "suspicious_strings": ["http://evil.com", "payload.exe", "keylogger"]
  },
  "dynamic_analysis": {
    "files_created": ["/tmp/keylog.txt", "/etc/cron.d/backdoor"],
    "registry_modified": ["HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run"],
    "processes_spawned": ["cmd.exe", "powershell.exe"],
    "network_connections": [
      {"ip": "185.220.101.45", "port": 8080, "protocol": "TCP"}
    ]
  },
  "threat_classification": {
    "family": "GenericTrojan",
    "type": "Trojan",
    "capabilities": ["keylogger", "backdoor", "c2"],
    "severity": "HIGH"
  },
  "virustotal": {
    "detections": 45,
    "total_engines": 70,
    "detection_rate": 64.3
  }
}
```

## Best Practices

1. **✅ ALWAYS use isolated environment** (VM/Docker/E2B)
2. **✅ Network isolation** (no internet or separate VLAN)
3. **✅ Snapshot before execution** (revert after analysis)
4. **✅ Encrypt malware samples** (password-protected archives)
5. **✅ Document everything** (screenshots, logs, IOCs)
6. **✅ Time-limited execution** (max 10 minutes)
7. **✅ No sensitive data** in sandbox
8. **✅ Automated cleanup** (delete samples after analysis)
9. **✅ Legal compliance** (obtain proper authorization)
10. **✅ Threat intelligence** (share IOCs with community)

## Integration Points

- **/re:network-traffic** - Network analysis
- **/re:memory-dump** - Memory forensics
- **/re:decompile** - Static analysis
- **Flow-Nexus Sandboxes** - Cloud-based isolation

## Agent Integration

```javascript
// Security Analyst: Automated malware analysis
mcp__flow-nexus__sandbox_create({
  template: 'base',
  env_vars: { ANALYSIS_MODE: 'malware' },
  timeout: 600
})

// Threat Intel: IOC correlation
mcp__ruv-swarm__agent_spawn({
  type: "analyst",
  capabilities: ["threat-intelligence", "malware-analysis"]
})
```

## Related Commands

- `/re:network-traffic` - Network analysis
- `/re:memory-dump` - Memory forensics
- `/re:decompile` - Reverse engineering

---

**Implementation Status**: Production-Ready
**Security Level**: CRITICAL
**Last Updated**: 2025-11-01
**Maintainer**: Security Research Specialist

**⚠️ WARNING**: This command is for authorized security research and incident response only. Unauthorized malware analysis may be illegal.
